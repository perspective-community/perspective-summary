var b=class{poll_handle;server;constructor(t){this.server=t}set_poll_handle(){return this.poll_handle=new Promise((t,r)=>setTimeout(()=>this.server.poll().then(t).catch(r).finally(()=>{this.poll_handle=void 0}))),this.poll_handle}async on_poll_request(){this.poll_handle?await this.poll_handle.then(()=>{if(!this.poll_handle)return this.set_poll_handle()}):await this.set_poll_handle()}},v=class{clients;server;module;on_poll_request;constructor(t,r){this.clients=new Map,this.module=t,this.on_poll_request=r?.on_poll_request,this.server=t._psp_new_server(r?.on_poll_request?1:0)}make_session(t){let r=this.module._psp_new_session(this.server);return this.clients.set(r,t),new w(this.module,this.server,r,this.clients,this.on_poll_request&&(()=>this.on_poll_request(this)))}async poll(){let t=this.module._psp_poll(this.server);await P(this.module,t,async r=>{await this.clients.get(r.client_id)(r.data)})}delete(){this.module._psp_delete_server(this.server)}},w=class{constructor(t,r,n,a,p){this.mod=t;this.server=r;this.client_id=n;this.client_map=a;this.on_poll_request=p}async handle_request(t){let r=await B(this.mod,t,async n=>this.mod._psp_handle_request(this.server,this.client_id,n,this.mod._psp_is_memory64()?BigInt(t.byteLength):t.byteLength));await P(this.mod,r,async n=>{await this.client_map.get(n.client_id)(n.data)}),this.on_poll_request?await this.on_poll_request():await this.poll()}async poll(){let t=this.mod._psp_poll(this.server);await P(this.mod,t,async r=>{r.client_id===0?await this.client_map.get(this.client_id)(r.data):await this.client_map.get(r.client_id)(r.data)})}close(){this.mod._psp_close_session(this.server,this.client_id)}};async function B(i,t,r){let n=i._psp_alloc(i._psp_is_memory64()?BigInt(t.byteLength):t.byteLength);i.HEAPU8.set(t,Number(n));let a=await r(n);return i._psp_free(n),a}async function P(i,t,r){let n=i._psp_is_memory64(),a=new DataView(i.HEAPU8.buffer,Number(t),n?12:8),p=a.getUint32(0,!0),u=n?a.getBigInt64(4,!0):a.getUint32(4,!0),e=new DataView(i.HEAPU8.buffer,Number(u),p*(n?16:12));try{for(let s=0;s<p;s++){let[o,l,f]=n?[e.getBigInt64(s*16,!0),e.getInt32(s*16+8,!0),e.getInt32(s*16+12,!0)]:[e.getInt32(s*12,!0),e.getInt32(s*12+4,!0),e.getInt32(s*12+8,!0)],c=new Uint8Array(i.HEAPU8.buffer,Number(o),l);await r({client_id:f,data:c})}}finally{for(let s=0;s<p;s++){let o=n?e.getBigInt64(s*16,!0):e.getInt32(s*12,!0);i._psp_free(o)}i._psp_free(n?BigInt(e.byteOffset):e.byteOffset),i._psp_free(n?BigInt(a.byteOffset):a.byteOffset)}}var I=console.log.bind(console),S=console.error.bind(console),H=new TextDecoder("utf8"),q=[null,[],[]];function L(i,t=0,r=NaN){for(var n=t+r,a=t;i[a]&&!(a>=n);)++a;return H.decode(i instanceof Uint8Array?i.subarray(t,a):new Uint8Array(i.slice(t,a)))}function A(i,t){var r=q[i];t===0||t===10?((i===1?I:S)(L(r,0)),r.length=0):r.push(t)}async function E(i){let t,r=!1,n,a={HaveOffsetConverter(){console.error("HaveOffsetConverter")},__syscall_ftruncate64(...e){console.error("__syscall_frtuncate64",e)},__syscall_getdents64(...e){console.error("__syscall_frtuncate64",e)},__syscall_unlinkat(...e){console.error("__syscall_frtuncate64",e)},__throw_exception_with_stack_trace(e){let s=new WebAssembly.Exception(t.__cpp_exception,[e],{traceStack:!0});throw s.message="Unexpected internal error",s},clock_time_get(e,s,o){if(r){if(o=o,o=Number(o),!(e==0||e==1||e==2||e==3))return 28;var l;e===0?l=Date.now():l=performance.now();let c=Math.round(l*1e3*1e3),_=new BigInt64Array(n.buffer);return _[o/8]=BigInt(c),0}else{if(o=o,o>>>=0,!(e==0||e==1||e==2||e==3))return 28;var l;e===0?l=Date.now():l=performance.now();var f=Math.round(l*1e6);let _=new BigInt64Array(n.buffer);return _[o>>>3]=BigInt(f),0}},emscripten_asm_const_int(...e){return 0},emscripten_notify_memory_growth(e){r?e=Number(e):(e=e,e>>>=0),e!=0&&console.error("abort")},environ_get(...e){return 0},environ_sizes_get(...e){return 0},fd_close(...e){return console.error("fd_close",e),0},fd_read(...e){return console.error("fd_read",e),0},fd_seek(...e){return console.error("fs_seek",e),0},fd_write(e,s,o,l){let f=new Uint8Array(n.buffer);if(r){s=Number(s),o=Number(o),l=Number(l);let c=0,_=new BigUint64Array(n.buffer);for(let y=0;y<o;y++){let g=Number(_[s/8]),d=Number(_[(s+8)/8]);s+=16;for(let m=0;m<d;m++)A(e,f[g+m]);c+=d}return _[l/8]=BigInt(c),0}else{s=s,o=o,l=l,s>>>=0,o>>>=0,l>>>=0;let c=0,_=new Uint32Array(n.buffer);for(let y=0;y<o;y++){let g=_[s>>>2>>>0],d=_[s+4>>>2>>>0];s+=8;for(let m=0;m<d;m++)A(e,f[g+m>>>0]);c+=d}return _[l>>>2>>>0]=c,0}},proc_exit(e){return console.error("proc_exit",e),0}},p=await i.instantiateWasm({env:a,wasi_snapshot_preview1:a},e=>{t=e.exports,r=!!t.psp_is_memory64(),n=e.exports.memory,t._initialize()}),u={};for(let[e,s]of Object.entries(p))u[`_${e}`]=s;return{...p,...u,get HEAPU8(){return new Uint8Array(n.buffer)}}}async function U(i){let t=await E({locateFile(r){return r},instantiateWasm:async(r,n)=>{r.env={...r.env,psp_stack_trace(){let p=Error().stack||"",e=new TextEncoder().encode(p),s=t._psp_alloc(t._psp_is_memory64()?BigInt(e.byteLength+1):e.byteLength+1);return t.HEAPU8.set(e,Number(s)),t.HEAPU8[Number(s)+e.byteLength]=0,s},psp_heap_size(){return t._psp_is_memory64()?BigInt(t.HEAPU8.buffer.byteLength):t.HEAPU8.buffer.byteLength}};let a=await WebAssembly.instantiate(i,r);return n(a.instance),a.instance.exports}});return t}var h,M;function x(i){let t=i.ports[0],r;t.addEventListener("message",async n=>{if(n.data.cmd==="init"){let a=n.data.id;if(!h){let p=await U(n.data.args[0]);h=new v(p,{on_poll_request:()=>M.on_poll_request()}),M=new b(h)}r=h.make_session(async p=>{let u=p.slice().buffer;t.postMessage(u,{transfer:[u]})}),t.postMessage({id:a})}else await r.handle_request(new Uint8Array(n.data))}),t.start()}self.addEventListener("connect",x);self.addEventListener("message",x);
//# sourceMappingURL=perspective-server.worker.js.map
